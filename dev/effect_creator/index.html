<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Ability Creator</title>
    <link rel="icon" href="../../img/icons/w.png"/>
    <link rel="stylesheet" href="../../style.css"/>
  </head>
  <body>
    <h1>Ability Effects Creator</h1>
    <div style="display: flex;">
      <div style="width: 300px; padding: 1ch;">
        <h2>Import:</h2>
        <label for="load_abilities">Import from JSON string:</label>
        <br>
        <input type="file" id="load_abilities" accept=".json">
        <button id="import_text">Load</button>
        <br>
        <br>
        <label for="abilities_tree_selector">Generate new from tree:</label>
        <br>
        <select id="abilities_tree_selector">
          <option value="archer">Archer</option>
          <option value="assassin">Assassin</option>
          <option value="mage">Mage</option>
          <option value="shaman">Shaman</option>
          <option value="warrior">Warrior</option>
        </select>
        <button id="generate_tree">Load</button>
        <br>
        <br>

        <h2>Export:</h2>
        <button id="save_text">Save effects to file</button>
      </div>

      <div style="padding: 1ch;">
        <h2>Effect Editor:</h2>
        <div id="effect_editor" style="width: 300px">
          <div class="warn">No effect selected!</div>
          <label>Effect name:</label>
          <input class="name_input">
          <label>Effect type:</label>
          <select class="effect_type">
            <!-- TODO: start with an effect that adds an arbitrary equation at a given step -->
            <!-- TODO: from there, just add abstractions of that -->
            <option value="nothing">Nothing</option>
            <option value="script">Java Script at Step</option>
            <option value="spell">Casted Spell</option>
            <option value="attack">Attack</option>
            <option value="attack_mod">Attack Modifier</option>
            <option value="attack_multi">Attack Multiplier</option>
            <option value="attack">Attack Child</option>
            <option value="heal">Heal</option>
            <option value="heal">Heal Modifier</option>
            <option value="cost_mod">Spell Cost Modifier</option>
            <option value="mastery">Elemental Mastery</option>
            <option value="mastery">Elemental Mastery</option>
            <option value="blocker">Effect Blocker</option>
            <option value="condition">Status Condition Source</option>
            <option value="id_mod">Gear Identification Modifier</option>
            <option value="id_to_id">Identification Intertwine</option>
            <option value="">Fluid Healing?</option>
            <option value="">Commander MA/Pupper?</option>
            <option value="">Mana from Invig?</option>
          </select>
        </div>
      </div>
    </div>
    <div style="display: flex;">
      <div style="padding: 1ch;">
        <h2>Abilities:</h2>
        <div id="ability_holder" style="width: 34ch"></div>
      </div>

      <div style="padding: 1ch;">
        <h2>Effects:</h2>
        <div id="effect_holder" style="width: 300px"></div>
      </div>
    </div>

    <script src="../../src/data/trees.js"></script>
    <script src="../../src/data_manipulation/minecraft_html.js"></script>
    <script src="../../src/data/code_dictionary.js"></script>

    <script>
        class Editor {
            effect;
            effect_editor;

            constructor(effect_editor, name_input_class = "name_input", warn_input_class = "warn") {
                this.effect_editor = effect_editor;
                this.name_input = effect_editor.querySelector("." + name_input_class);
                this.warn = effect_editor.querySelector("." + warn_input_class);
                this.name_input.addEventListener("input", () => {
                    this.setEffectName(this.name_input.value);
                })
            }

            setEffect(effect) {
                this.warn.textContent = "";
                this.effect = effect;
                this.name_input.value = effect.name;
            }

            setEffectName(name) {
                if (this.effect) this.effect.setName(name);
            }
        }

        class Tree {
            abilities = {};
            effects = {};

            constructor(wynn_class, ability_holder_id = "ability_holder", effect_holder_id = "effect_holder", effect_editor_id = "effect_editor") {
                // TODO: Aspects are needed too. (id = "a" + number)?
                const abilities = punscake[wynn_class].abilities;
                this.ability_holder = document.getElementById(ability_holder_id);
                this.ability_holder.innerHTML = "";
                this.effect_holder = document.getElementById(effect_holder_id);
                this.effect_holder.innerHTML = "";

                this.editor = new Editor(document.getElementById(effect_editor_id));

                this.generateAbilities(abilities);
            }

            generateAbilities(abilities) {
                for (let index in abilities) {
                    const ability = new Ability(this, abilities[index]);
                    this.addAbility(index, ability);
                }
            }

            addAbility(index, ability) {
                this.abilities[index] = (ability);
                this.ability_holder.appendChild(ability.html);
            }

            addEffect(ability) {
                const effect = new Effect(ability);

                let index = -1;
                for (let i in this.effects) {
                    index = Math.max(index, i);
                }
                index++;

                this.effects[index] = effect;
                effect.setIndex(index);
                this.effect_holder.appendChild(effect.html);

                return effect;
            }

            removeEffect(index) {
                const effect = this.effects[index];
                effect.removeEffect();
                delete this.effects[index];
            }

            editEffect(index) {
                const effect = this.effects[index];
                this.editor.setEffect(effect)
                // TODO:
            }
        }

        class Ability {
            tree;
            abilityData;
            html;
            effectIndexes = [];
            effectsHolder;

            constructor(tree, abilityData) {
                this.tree = tree;
                this.abilityData = abilityData;
                this.createHTML();
            }

            createHTML() {
                this.html = document.createElement("div");
                this.html.classList.add("minecraftTooltip");

                const top = this.html.appendChild(document.createElement("div"));
                top.style.display = "flex";

                const nameplate = top.appendChild(document.createElement("div"));
                nameplate.classList.add("nameplate");
                nameplate.innerHTML = minecraftToHTML(this.abilityData.name);
                nameplate.style.flex = "1 1 auto";

                const add = top.appendChild(document.createElement("button"));
                add.textContent = "+";
                add.addEventListener("click", () => {
                    this.addEffect();
                });

                this.effectsHolder = this.html.appendChild(document.createElement("div"));
                this.effectsHolder.style.paddingLeft = "20px";
            }

            addEffect() {
                const effect = tree.addEffect(this);
                this.effectIndexes.push(effect.index);
                this.effectsHolder.appendChild(effect.addParentHTML());
            }

            removeEffect(index) {
                this.effectIndexes = this.effectIndexes.filter(effect => effect.index !== index);
                const i = this.effectIndexes.indexOf(index);
                if (i > -1) this.effectIndexes.splice(i, 1);
            }
        }

        class Effect {
            tree;
            parents = [];
            parentHTMLs = [];
            children = [];
            require_all_parents = true;
            html;
            index = -1;

            name = "";
            nameDisplay;

            constructor(parent) {
                this.tree = parent.tree;
                this.addParent(parent);
                this.createHTML();
                this.setName("")
            }

            createHTML() {
                this.html = document.createElement("div");
                this.html.classList.add("minecraftTooltip");

                this.top = this.html.appendChild(document.createElement("div"));
                this.top.style.display = "flex";

                const parentNames = this.top.appendChild(document.createElement("div"));
                parentNames.classList.add("nameplate");
                parentNames.innerHTML = minecraftToHTML(
                    this.parents.map(a => a.abilityData.name).join(this.require_all_parents ? " and " : " or "));
                parentNames.style.flex = "1 1 auto";

                const edit = this.top.appendChild(document.createElement("button"));
                edit.textContent = "âœ’";
                edit.addEventListener("click", () => {
                    this.tree.editEffect(this.index);
                })

                const remove = this.top.appendChild(document.createElement("button"));
                remove.textContent = "x";
                remove.addEventListener("click", () => {
                    this.tree.removeEffect(this.index);
                });

                this.nameDisplay = this.html.appendChild(document.createElement("div"));

            }

            addParent(parent) {
                this.parents.push(parent);
            }

            addParentEffect(effect) {}

            addParentHTML() {
                const newHTML = document.createElement("div");

                newHTML.textContent = this.name || "unnamed effect";

                this.parentHTMLs.push(newHTML);

                return newHTML;
            }

            setIndex(index) {
                this.index = index;
            }

            removeEffect() {
                this.html.remove();
                for (let i in this.parents) {
                    this.parents[i].removeEffect(this.index);
                }
                for (let i in this.parentHTMLs) {
                    this.parentHTMLs[i].remove();
                }
            }

            addChild(index) {
                this.children.push(index);
            }

            removeChild(index) {
                const i = this.children.indexOf(index);
                if (i > -1) this.children.splice(index, 1);
            }

            setName(name) {
                this.name = name;
                this.nameDisplay.textContent = this.name || "unnamed effect";
                for (let html of this.parentHTMLs) {
                    html.textContent = name;
                }
            }
        }
    </script>

    <script>
        // TODO: Aspects btw
        let tree = new Tree("archer");

        document.getElementById("generate_tree").addEventListener("click", () => {
            const treeName = document.getElementById("abilities_tree_selector").value;
            loadNewFromClass(treeName);
        });

        function loadNewFromClass(wynn_class) {
            tree = new Tree(wynn_class);
        }
    </script>
  </body>
</html>